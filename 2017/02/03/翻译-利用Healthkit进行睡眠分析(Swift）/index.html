<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>翻译-利用 Healthkit 进行睡眠分析（Swift） | Liberalism的博客</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="liberalism,iOS,Swift,nodejs,JavaScript" />
  

  <meta name="description" content="原文：http://appcoda.com/sleep-analysis-healthkit/
翻译：Liberalism
日期：2016年10月5日

现如今，睡眠变革已经成为了一种全新的潮流。用户比以往任何时候都更加关注自己的睡眠。他们不仅仅关心自己睡了多久，同样也很希望通过一段时间的数据收集和分析能够绘制出他们的睡眠趋势。而技术上的进步，包括硬件、特别是智能手机的高速发展，使睡眠变革这一高速">
<meta property="og:type" content="article">
<meta property="og:title" content="翻译-利用 Healthkit 进行睡眠分析（Swift）">
<meta property="og:url" content="http://yoursite.com/2017/02/03/翻译-利用Healthkit进行睡眠分析(Swift）/index.html">
<meta property="og:site_name" content="Liberalism的博客">
<meta property="og:description" content="原文：http://appcoda.com/sleep-analysis-healthkit/
翻译：Liberalism
日期：2016年10月5日

现如今，睡眠变革已经成为了一种全新的潮流。用户比以往任何时候都更加关注自己的睡眠。他们不仅仅关心自己睡了多久，同样也很希望通过一段时间的数据收集和分析能够绘制出他们的睡眠趋势。而技术上的进步，包括硬件、特别是智能手机的高速发展，使睡眠变革这一高速">
<meta property="og:image" content="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-01.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-02.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-03.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10">
<meta property="og:image" content="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-04.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10">
<meta property="og:updated_time" content="2017-02-22T06:09:20.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="翻译-利用 Healthkit 进行睡眠分析（Swift）">
<meta name="twitter:description" content="原文：http://appcoda.com/sleep-analysis-healthkit/
翻译：Liberalism
日期：2016年10月5日

现如今，睡眠变革已经成为了一种全新的潮流。用户比以往任何时候都更加关注自己的睡眠。他们不仅仅关心自己睡了多久，同样也很希望通过一段时间的数据收集和分析能够绘制出他们的睡眠趋势。而技术上的进步，包括硬件、特别是智能手机的高速发展，使睡眠变革这一高速">
<meta name="twitter:image" content="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-01.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  
    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  

  
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            rel="noopener noreferrer"
            target="_self"
            >
            iOS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            JS
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            rel="noopener noreferrer"
            target="_self"
            >
            翻译
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-简介"><span class="toc-text">1.简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-使用HealthKit-Framework"><span class="toc-text">2.使用HealthKit Framework</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-读取睡眠分析数据"><span class="toc-text">3.读取睡眠分析数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-App-测试"><span class="toc-text">4.App 测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-对使用-HealthKit-应用的一些建议"><span class="toc-text">5.对使用 HealthKit 应用的一些建议</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-翻译-利用Healthkit进行睡眠分析(Swift）" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">翻译-利用 Healthkit 进行睡眠分析（Swift）</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2017.02.03</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>John Doe</span>
        </span>
      

      


      
        <span>
          <i class="icon-comment"></i>
          <a href="http://www.xiaolu520.com/2017/02/03/翻译-利用Healthkit进行睡眠分析(Swift）/#disqus_thread"></a>
        </span>
      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      

      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>原文：<a href=""></a><a href="http://appcoda.com/sleep-analysis-healthkit/" target="_blank" rel="external">http://appcoda.com/sleep-analysis-healthkit/</a></p>
<p>翻译：Liberalism</p>
<p>日期：2016年10月5日</p>
<hr>
<p>现如今，睡眠变革已经成为了一种全新的潮流。用户比以往任何时候都更加关注自己的睡眠。他们不仅仅关心自己睡了多久，同样也很希望通过一段时间的数据收集和分析能够绘制出他们的睡眠趋势。而技术上的进步，包括硬件、特别是智能手机的高速发展，使睡眠变革这一高速发展的领域迎来了全新的曙光。</p>
<p>苹果在基于安全的前提下，提供了一种非常酷的方式来与用户的个人健康信息进行通信，并通过iOS内置的<code>健康</code>应用存储信息。作为开发者不仅可以使用<code>HealyhKit</code>来打造健康类的<code>App</code>，同时该框架还允许开发者访问睡眠数据，进行处理分析。</p>
<p>在本教程中，针对<code>Healthkit</code>框架我会带领大家快速入门，同时会向大家演示如果快速搭建一个简单的睡眠分析的App</p>
<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><blockquote>
<p><code>HealthKit</code>框架结构提供了一个称之为<code>HealthKit Store</code>的加密数据库，开发者可以使用<code>HKhealth Store</code>这个类来访问这个数据库。iPhone和Apple Watch分别有自己的<code>HealthKit Store</code>，健康数据会在iPhone和Apple Watch之间同步。然而，Apple Watch为了节省内存空间会自动清理掉一些旧的数据。目前<code>healthKit</code>框架和健康类的App在iPad上是不支持的。</p>
</blockquote>
<p>如果你想创建一个基于健康数据的iOS App或者是WatchOS App，<code>HealthKit</code>框架无疑是非常强大的一个工具。HealthKit设计的初衷是管理来源广泛的数据，基于用户喜好把来源不同的数据进行自动合并。应用程序还可以访问每个源的原始数据，并将数据本身合并。App不仅仅用于身体指标的检测、健身或营养情况，还可以用于睡眠分析</p>
<p>那么在接下来的文章里，我会向大家展示在iOS平台上如何利用<code>HealthKit</code>框架去存储、连接睡眠的分析数据。以上的方法也同样适用于watchOS平台上应用。需要注意的是这篇教程使用了Swift2.0和Xcode 7，所以为了接下来的课程，请确保你目前正在使用的Xcode 7</p>
<p>在我们正式开始之前，请提前下载好我们的项目并且解压。我已经创建好了基本的UI界面。当你运行时，你会看到一个计时器的UI界面，当你按下开始按钮之后，就会发现开始计时。</p>
<h2 id="2-使用HealthKit-Framework"><a href="#2-使用HealthKit-Framework" class="headerlink" title="2.使用HealthKit Framework"></a>2.使用HealthKit Framework</h2><p>我们App的目标是存储睡眠的分析信息，并通过开始和结束两个按钮检索信息。要使用<code>HealthKit</code>，首先应该在你应用的bundle中打开<code>HealthKit</code>的权限。在你的项目中，在导航中找到当前的target -&gt; 再找到 capabilities，然后打开。</p>
<p><img src="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-01.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt=""></p>
<p>接下来你需要按照以下的代码在ViewController类里创建一个HKHealthStore的实例变量</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">let</span> healthStore = <span class="type">HKHealthStore</span>()</div></pre></td></tr></table></figure>
<p>然后，我们将利用<code>HKHealthStore</code>这个实例变量去连接<code>HealthKit Store</code>这个加密数据库。</p>
<p>如之前所说，<code>HealthKit</code>允许用户掌握自己的健康数据，所以在你可以操作、分析用户的睡眠数据之前，你首先需要去获取用户许可。获取许可，首先要导入HealthKit Framework，然后如下面一样更新<code>ViewDidLoad</code>中的代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewDidLoad()</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> typestoRead = <span class="type">Set</span>([</div><div class="line">        <span class="type">HKObjectType</span>.categoryTypeForIdentifier(<span class="type">HKCategoryTypeIdentifierSleepAnalysis</span>)!</div><div class="line">        ])</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> typestoShare = <span class="type">Set</span>([</div><div class="line">        <span class="type">HKObjectType</span>.categoryTypeForIdentifier(<span class="type">HKCategoryTypeIdentifierSleepAnalysis</span>)!</div><div class="line">        ])</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.healthStore.requestAuthorizationToShareTypes(typestoShare, readTypes: typestoRead) &#123; (success, error) -&gt; <span class="type">Void</span> <span class="keyword">in</span></div><div class="line">        <span class="keyword">if</span> success == <span class="literal">false</span> &#123;</div><div class="line">            <span class="type">NSLog</span>(<span class="string">" Display not allowed"</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上代码可以提供给用户<code>同意</code>或<code>拒绝</code>的提示，通过<code>block</code>，你可以在处理成功和失败后进行相应的操作并获得最终的结果。没有必要一直向用户请求许可，你必须很好的处理程序中的各种错误</p>
<p>但是为了避免用户的误操作，用户必须在设置页面亲自打开允许按钮，这样才能确保真正获得设备上健康数据的权限</p>
<p><img src="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-02.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt=""></p>
<p>写入睡眠分析数据</p>
<p>首先，如何去检索睡眠分析数据呢？根据苹果官方文档的说法，每一个睡眠分析的样本都有一个唯一值，为了确保用户是躺下并且入睡，HealthKit在同一时间内会对两个或更多的数据进行采样。通过对这些样本的开始时间和结束时间进行对比，应用程序可以进行大量的二次统计和计算。</p>
<ul>
<li>用户花费多少时间入睡。</li>
<li>用户躺在床上实际入睡时间所占的比例</li>
<li>用户醒来之后，会在床上躺多久</li>
<li>用户在床上，以及睡眠时所花费的时间汇总<br><img src="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-03.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt=""></li>
</ul>
<p>简明的讲，把睡眠分析数据储存到HealthKit store数据库中时，你需要遵循以下方法</p>
<hr>
<ul>
<li>首先我们需要定义两个NSDate对象去对应开始时间和结束时间。</li>
</ul>
<ul>
<li>然后我们利用<code>HKCategoryTypeIdentifierSleepAnalysis</code>创建一个<code>HKObjectType</code>的实例变量</li>
</ul>
<ul>
<li>我们需要创建一个全新的<code>HKCategorySample</code>类型的对象，通常采用分类样本的方式来存储睡眠数据，独立的样本代表用户躺在床上或者入睡的时间段。所以我们可以在同一时间段内分别创建出<code>在床上未入睡</code>以及<code>入睡之后</code>的样本</li>
</ul>
<ul>
<li>最终，我们就可以利用<code>HKHealthStore</code>类中的<code>saveObject</code>方法把对象存储起来</li>
</ul>
<hr>
<blockquote>
<p>编者提示：如果想查看样本的类型，可以查阅<br><a href="https://developer.apple.com/reference/healthkit/healthkit_constants#//apple_ref/doc/uid/TP40014710" target="_blank" rel="external"><code>HealthKit</code>官方文档</a></p>
</blockquote>
<hr>
<p>如果你把以上的注意点和方法转化到Swift中，以下就是把<code>躺床上未入睡</code>和<code>入睡</code>的分析数据储存起来的代码，请把以下代码插入到<code>ViewController</code>类中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveSleepAnalysis</span><span class="params">()</span></span> &#123;</div><div class="line">    </div><div class="line">    <span class="comment">// alarmTime and endTime are NSDate objects</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> sleepType = <span class="type">HKObjectType</span>.categoryTypeForIdentifier(<span class="type">HKCategoryTypeIdentifierSleepAnalysis</span>) &#123;</div><div class="line">        </div><div class="line">        <span class="comment">// we create our new object we want to push in Health app</span></div><div class="line">        <span class="keyword">let</span> object = <span class="type">HKCategorySample</span>(type:sleepType, value: <span class="type">HKCategoryValueSleepAnalysis</span>.<span class="type">InBed</span>.rawValue, startDate: <span class="keyword">self</span>.alarmTime, endDate: <span class="keyword">self</span>.endTime)</div><div class="line">        </div><div class="line">        <span class="comment">// at the end, we save it</span></div><div class="line">        healthStore.saveObject(object, withCompletion: &#123; (success, error) -&gt; <span class="type">Void</span> <span class="keyword">in</span></div><div class="line">            </div><div class="line">            <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</div><div class="line">                <span class="comment">// something happened</span></div><div class="line">                <span class="keyword">return</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> success &#123;</div><div class="line">                <span class="built_in">print</span>(<span class="string">"My new data was saved in HealthKit"</span>)    </div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// something happened again</span></div><div class="line">            &#125;     </div><div class="line">        &#125;)</div><div class="line">        <span class="keyword">let</span> object2 = <span class="type">HKCategorySample</span>(type:sleepType, value: <span class="type">HKCategoryValueSleepAnalysis</span>.<span class="type">Asleep</span>.rawValue, startDate: <span class="keyword">self</span>.alarmTime, endDate: <span class="keyword">self</span>.endTime)</div><div class="line">        </div><div class="line">        healthStore.saveObject(object2, withCompletion: &#123; (success, error) -&gt; <span class="type">Void</span> <span class="keyword">in</span></div><div class="line">            <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</div><div class="line">                <span class="comment">// something happened</span></div><div class="line">                <span class="keyword">return</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> success &#123;</div><div class="line">                <span class="built_in">print</span>(<span class="string">"My new data (2) was saved in HealthKit"</span>)</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// something happened again</span></div><div class="line">            &#125;  </div><div class="line">        &#125;)   </div><div class="line">    &#125;   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法会在我们想把睡眠分析数据存储到<code>HealthKit</code>中时被调用</p>
<h2 id="3-读取睡眠分析数据"><a href="#3-读取睡眠分析数据" class="headerlink" title="3.读取睡眠分析数据"></a>3.读取睡眠分析数据</h2><ul>
<li>想要读取睡眠分析数据，我们需要创建一个查询对象。首先需要为<code>HKCategoryTypeIdentifierSleepAnalysis</code>定义一个<code>HKObjectType</code>类型的分类。或许你希望通过谓词在开始时间和结束时间这个你需要的时间段内进行筛选、检索数据。你也需要为分类检索查询创建 一个分类描述器以获取我们想要的结果</li>
</ul>
<p>您的用于检索睡眠分析数据的代码应如下所示：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">retrieveSleepAnalysis</span><span class="params">()</span></span> &#123;</div><div class="line">    </div><div class="line">    <span class="comment">// first, we define the object type we want</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> sleepType = <span class="type">HKObjectType</span>.categoryTypeForIdentifier(<span class="type">HKCategoryTypeIdentifierSleepAnalysis</span>) &#123;</div><div class="line">        </div><div class="line">        <span class="comment">// Use a sortDescriptor to get the recent data first</span></div><div class="line">        <span class="keyword">let</span> sortDescriptor = <span class="type">NSSortDescriptor</span>(key: <span class="type">HKSampleSortIdentifierEndDate</span>, ascending: <span class="literal">false</span>)</div><div class="line">        </div><div class="line">        <span class="comment">// we create our query with a block completion to execute</span></div><div class="line">        <span class="keyword">let</span> query = <span class="type">HKSampleQuery</span>(sampleType: sleepType, predicate: <span class="literal">nil</span>, limit: <span class="number">30</span>, sortDescriptors: [sortDescriptor]) &#123; (query, tmpResult, error) -&gt; <span class="type">Void</span> <span class="keyword">in</span></div><div class="line">            </div><div class="line">            <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</div><div class="line">                </div><div class="line">                <span class="comment">// something happened</span></div><div class="line">                <span class="keyword">return</span></div><div class="line">                </div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> <span class="keyword">let</span> result = tmpResult &#123;</div><div class="line">                </div><div class="line">                <span class="comment">// do something with my data</span></div><div class="line">                <span class="keyword">for</span> item <span class="keyword">in</span> result &#123;</div><div class="line">                </div><div class="line">                    <span class="keyword">if</span> <span class="keyword">let</span> sample = item <span class="keyword">as</span>? <span class="type">HKCategorySample</span> &#123;</div><div class="line">                    </div><div class="line">                        <span class="keyword">let</span> value = (sample.value == <span class="type">HKCategoryValueSleepAnalysis</span>.<span class="type">InBed</span>.rawValue) ? <span class="string">"InBed"</span> : <span class="string">"Asleep"</span></div><div class="line">                        </div><div class="line">                        <span class="built_in">print</span>(<span class="string">"Healthkit sleep: <span class="subst">\(sample.startDate)</span> <span class="subst">\(sample.endDate)</span> - value: <span class="subst">\(value)</span>"</span>)</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// finally, we execute our query</span></div><div class="line">        healthStore.executeQuery(query)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此代码查询<code>HealthKit</code>以获取所有睡眠分析数据，然后将其按降序排序。 然后使用<code>startDate</code>和<code>endDate</code>以及值的类型（即In Bed或Asleep）打印每个查询。 我已将限制设置为30，以检索最近30个记录的样本。 您还可以使用谓词方法来选择自定义的开始和结束日期。</p>
<h2 id="4-App-测试"><a href="#4-App-测试" class="headerlink" title="4.App 测试"></a>4.App 测试</h2><p>对于演示应用程序，我使用<code>NSTimer</code>显示自您按下启动按钮以来经过的时间。 <code>NSDate</code>对象在开始和结束按钮上创建，以将睡眠分析数据保存为已用时间。 在停止操作方法中，可以调用<code>saveSleepAnalysis（）</code>和<code>retrieveSleepAnalysis（）</code>方法来保存和获取睡眠数据。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">stop</span><span class="params">(sender: AnyObject)</span></span> &#123;</div><div class="line">    endTime = <span class="type">NSDate</span>()</div><div class="line">    saveSleepAnalysis()</div><div class="line">    retrieveSleepAnalysis()</div><div class="line">    timer.invalidate()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在您的应用程序中，您可能需要更改<code>NSDate</code>对象以选择相关的开始和结束时间（可能不同），以保存躺在床上的数据和睡眠值。</p>
<p>完成更改后，您可以运行演示应用并启动计时器。让它运行几分钟，然后点击停止按钮。之后打开<code>健康</code>应用程序。你会发现睡眠数据。</p>
<p><img src="http://okhqmtd8q.bkt.clouddn.com/translate/image/Healthkit-04.png?watermark/2/text/QExpYmVyYWxpc20=/font/5a6L5L2T/fontsize/800/fill/IzhBMTgxOA==/dissolve/100/gravity/SouthEast/dx/10/dy/10" alt=""></p>
<h2 id="5-对使用-HealthKit-应用的一些建议"><a href="#5-对使用-HealthKit-应用的一些建议" class="headerlink" title="5.对使用 HealthKit 应用的一些建议"></a>5.对使用 <code>HealthKit</code> 应用的一些建议</h2><p><code>HealthKit</code>旨在为应用开发人员提供一个通用平台，以便轻松共享和访问用户数据，并避免数据中可能的重复或不一致。苹果审查指南非常明确的说明应用程序使用<code>HealthKit</code>和访问用户<code>读/写权限</code>必须通过向用户请求，但没有清楚地阐述<code>HealthKit</code>的使用可能会导致应用程序被拒绝。</p>
<p>将假的或不正确的数据保存到<code>健康</code>的应用程序也将被拒绝。 这意味着，你不能天真地使用算法来计算不同的健康值，如本教程中的睡眠分析。 您应该尝试使用内置的传感器数据读取和操作任何参数，以避免计算假数据。</p>
<p>对于完整的Xcode项目，你可以在这里<a href="https://github.com/appcoda/SleepAnalysis" target="_blank" rel="external">得到</a>。</p>

    
  </div>
</article>


   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持Liberalism</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/images/qr-wechat.png" alt="">
          </li>
        
          <li class="item">
            <img src="/images/qr-alipay.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2017/01/30/SVN上文件被locked的解决办法/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2017/02/03/制作正式版 Mac OS 10.12 安装 U盘/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              rel="noopener noreferrer"
              target="_self"
              >
              iOS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              JS
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              rel="noopener noreferrer"
              target="_self"
              >
              翻译
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'Liberalism';
    
    var disqus_url = 'http://yoursite.com/2017/02/03/翻译-利用Healthkit进行睡眠分析(Swift）/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//Liberalism.disqus.com/count.js" async></script>



    




  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
